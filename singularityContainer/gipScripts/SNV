#samples=c("Dog3","Dog1-P2")
#gipOut="gipOut"
#outName=NA
#chrs=NA
#debug=FALSE
#coordCartesianYlim=NA
#minVRF=0


suppressPackageStartupMessages(library("argparse"))
parser <- ArgumentParser(description="Compare SNVs in multiple samples")
parser$add_argument("--samples" , nargs="+", required=TRUE, help="Sample names. It determines the plotting order [required]" )
parser$add_argument("--gipOut"  , required=TRUE , help="GIP output directory [default %(default)s]" , default="NA")
parser$add_argument("--outName" , help="Output name [default %(default)s]" , default="NA")
parser$add_argument("--chrs"    , nargs="+" , help="Chromosomes to use. If \"NA\" it uses the same chromsomes as GIP [default %(default)s]" , default="NA")
parser$add_argument("--coordCartesianYlim" , help="Max y-axis value for density plots. If \"NA\" the value is automatically attributed [default %(default)s]" , default="NA")
parser$add_argument("--minVRF" , type="double" , help="Discard SNVs with frequency < --minVRF [default %(default)s]" , default=0)
parser$add_argument("--debug"  , action="store_true" , help="Dump session and quit [default %(default)s]" , default=FALSE)
args <- parser$parse_args()
#patch NA
for (n in names(args)){if(args[[n]][1] == "NA"){args[[n]] <- NA}  }
for (n in names(args)){assign(n,args[[n]]) }

suppressPackageStartupMessages(library("data.table"))
suppressPackageStartupMessages(library("ggplot2"))
suppressPackageStartupMessages(library("openxlsx"))
suppressPackageStartupMessages(library("session"))
suppressPackageStartupMessages(library("venn"))
suppressPackageStartupMessages(library("RColorBrewer"))
options(datatable.fread.input.cmd.message=FALSE)
if(debug){save.session("session_DEBUG_SNV");quit()}

#setup
outDir <- paste0(gipOut,"/sampleComparison/")
system(paste0("mkdir -p ", outDir))
if (is.na(outName)){
  outName <- paste0(outDir,"SNV")
}
chrSel      <- as.character(read.table(paste0(gipOut,"/samples/",samples[1],"/chrCoverageMedians_",samples[1]),header=T)[,1])
chrSize     <- read.table(paste0(gipOut,"/genome/genome.chrSize"),sep="\t", stringsAsFactors = F, header=F , col.names=c("chr","size"))
chrSize$chr <- as.character(chrSize$chr)
chrSize     <- chrSize[match(chrSel,chrSize$chr),]
if (is.na (chrs[1])){
  chrs <- chrSize$chr
}
chrSize <- chrSize[chrSize$chr %in% chrs,]

#chr size cumulative sum
chrSizeCumSum <- cumsum(chrSize$size)
v <- c(0,chrSizeCumSum)
chrSizeCumSum <- v[-length(v)]
names(chrSizeCumSum) <- chrSize$chr

#chr mid points
chrMids <- c()
for (i in 1:length(chrSizeCumSum)-1) {chrMids = c(chrMids , (chrSizeCumSum[i] + chrSizeCumSum[i + 1]) / 2)}
chrMids = c(chrMids ,  ( chrSizeCumSum[length(chrSizeCumSum)] + sum(chrSize$size) ) / 2)

###################
#read and reformat#
###################
snvDf <- list()
for (s in samples) {
  snvDf[[s]]  <- as.data.frame(fread(cmd=paste0("gunzip -c ", gipOut , "/samples/",s,"/",s,"_freebayesFiltered/singleVariants.df.gz"), header=T) , stringsAsFactors=FALSE)
  row.names(snvDf[[s]]) <- paste(snvDf[[s]]$chr , snvDf[[s]]$position , sep="_")
  snvDf[[s]]$tag    <- paste(snvDf[[s]]$chr , snvDf[[s]]$position , snvDf[[s]]$ref_alt ,sep="_")
  #filter VRF
  snvDf[[s]] <- snvDf[[s]][ snvDf[[s]]$freq >= minVRF , ]
  snvDf[[s]]$sample <- s
}
df <- do.call(rbind,snvDf)

#PLOT
pdf(paste0(outName,".pdf"),width=10)
#density plots
p <- ggplot(df, aes(freq, colour = sample)) + geom_density() + theme_bw() + facet_wrap(~chr) + scale_color_brewer(palette="Set1") + xlab("frequency") + theme(axis.text.x = element_text(angle = 90, hjust = 1))
if(! is.na(coordCartesianYlim)) { 
  p <- p + coord_cartesian(ylim=c(0,as.numeric(coordCartesianYlim)))
}
print (p)

#tot SNV per chr (sorted by chr size)
chrNamesSortedByRealSize <- chrSize[with(chrSize, order(size)), "chr"]
df$chr <- factor(df$chr,levels=chrNamesSortedByRealSize)
print( ggplot(df, aes(chr, fill = sample)) + geom_bar(stat="count") + theme_bw() + xlab("chromosome") + ylab("number of SNV") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_brewer(palette="Set1") )

#position/VRF: genome overview
positionCorrection <- chrSizeCumSum[match(df$chr, names(chrSizeCumSum))]
df$startFixed <- df$position + positionCorrection
p <- ggplot(df, aes(startFixed,freq)) 
p <- p + scale_x_continuous(breaks=chrMids, labels=chrs , lim=c(0 , sum(chrSize$size)))
p <- p + geom_point(aes(colour=(sample)),alpha=0.5) + theme_bw() +  ylab("variant frequency") + scale_colour_brewer(name="sample" , palette = "Set1" ) + expand_limits(y = 0) + xlab("chromosome")
p <- p + geom_vline(xintercept = chrSizeCumSum[-1])
print(p)

#position/VRF: faceting
#prepare df with x and y axes range
axesDf <- data.frame(x = numeric(), y = numeric(), chr = character())
for (chr in chrSize$chr){ 
 size <- chrSize[ match(chr , chrSize$chr) , "size" ]
 axesDf <- rbind(axesDf, data.frame(x = 0    , y = 0, chr = chr))
 axesDf <- rbind(axesDf, data.frame(x = size , y = 1, chr = chr))
}
p <- ggplot() + geom_point(data=df , aes(x=position, y=freq , colour=sample),alpha=0.5) 
p <- p + geom_blank(data = axesDf, aes(x = x, y = y)) 
p <- p + theme_bw() + facet_wrap(~chr, scales = "free") + scale_color_brewer(palette="Set1") + xlab("position") + ylab("frequency") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) 
print(p)

#position/VRF: separate plots
for (chr in chrs){
  p <- ggplot(df [df$chr == chr,], aes(position,freq)) + geom_point(aes(colour=(sample)),alpha=0.5) + xlim(0 , chrSize[chrSize$chr == chr, "size"]) + theme_bw() + ggtitle(paste("chromosome",chr)) +  ylab("variant frequency") + scale_colour_brewer(name="sample" , palette = "Set1") + expand_limits(y = 0)
  print(p)
}

#Allele specific plots (VRF/VRF plot and Venn plot)
#i.e. SNVs at the same position in different samples are considerent different if the alternative (ALT) nucleotide is different (1_2000_A_T != 1_2000_A_C)
#VRF/VRF scatter plots. 
unionPositions = unique(df$tag)
VRFs = lapply(snvDf, function(x, unionPos){
        sampleVRF = rep(0, length(unionPos))
        sampleVRF[match(x$tag, unionPos)] = x$freq
        return(sampleVRF)
}, unionPositions)
VRFmat = do.call(cbind, VRFs)
row.names(VRFmat) <- unionPositions
pairs(VRFmat , upper.panel = NULL , pch=19 , cex=0.5,main="union of all SNVs")
VRFmatIntersect <- VRFmat [ apply(VRFmat,1,function(x){!any(x==0) } ) , ]
pairs(VRFmatIntersect , upper.panel = NULL , pch=19 , cex=0.5,main="intersection of SNVs in all samples")

#Venn
tagL <- list()
for (s in samples){
  tagL[[s]] <- snvDf[[s]]$tag
}
cols <- c()
#if < 3 samples brew.pal does not work and you need to pass colors manually
if (length(samples) == 2) {
  cols = c('#e41a1c' , '#377eb8')
} else {
  cols = brewer.pal(length(samples), "Set1")
}
venn(tagL , ilabels = TRUE, cexil=1.1 , cexsn = 1.3 , zcolor=cols)
invisible(dev.off())

#out table
VRFmat <- as.data.frame(VRFmat)
funIndx <- unique(df[,c("tag","EFF","gene_annotation")])
VRFmat$EFF <- funIndx [ match(row.names(VRFmat) , funIndx$tag) , c("EFF") ]
VRFmat$gene_annotation <- funIndx [ match(row.names(VRFmat) , funIndx$tag) , c("gene_annotation") ]
VRFmat$SNV <- row.names(VRFmat)
VRFmat <- VRFmat[,c(ncol(VRFmat),1:(ncol(VRFmat)-1)) ]
for(i in 2:(length(samples)+1)){
  names(VRFmat)[i] <- paste0("frequency_",names(VRFmat)[i])
}
write.xlsx(file=paste0(outName,".xlsx") , x=VRFmat , asTable=TRUE)


